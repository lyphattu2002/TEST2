--CAU1
GO
USE QLHANG
GO
--TAOBANG
CREATE TABLE VatTu(
	MaVT VARCHAR(10) PRIMARY KEY,
	TenVT VARCHAR(50),
	DVTinh NVARCHAR(50),
	SLCon INT
);

CREATE TABLE HDBan(
	MaHD VARCHAR(10) PRIMARY KEY,
	NgayXuat DATE,
	HoTenKhach NVARCHAR(50)
);

CREATE TABLE HANGXUAT(
    MaHD varchar(10),
    MaVT varchar(10),
    DonGia INT,
    SLBan INT,
    CONSTRAINT HANGXUAT_PK PRIMARY KEY (MAHD, MAVT)
);

ALTER TABLE HANGXUAT ADD CONSTRAINT FK_HANGXUAT_HDBAN
FOREIGN KEY (MAHD) REFERENCES HDBAN (MAHD);
ALTER TABLE HANGXUAT ADD CONSTRAINT FK_HANGXUAT_VATTU
FOREIGN KEY (MAVT) REFERENCES VATTU (MAVT);

INSERT INTO VATTU VALUES
('VT001', 'GACH', 'VIEN', 5000000),
('VT002', 'XI-MANG', 'BAO', 80000);

INSERT INTO HDBAN VALUES
('HD001', '2022-1-1', 'NGUYEN VAN TUAN TU'),
('HD002', '2022-1-5', 'TRAN VAN TUAN NHAN');

INSERT INTO HANGXUAT VALUES
('HD001', 'VT001', 9000, 200),
('HD001', 'VT002', 55000, 50),
('HD002', 'VT001', 8200, 120),
('HD002', 'VT002', 34000, 60);

-- CAU 2
SELECT TOP 1
MaHD, SUM(SLBan * DonGia) AS N'Tổng Tiền'
FROM HANGXUAT
GROUP BY MAHD
ORDER BY SUM(SLBAN * DONGIA) DESC;

-- CAU 1
CREATE DATABASE QLHANG
GO
USE QLHANG
GO

CREATE TABLE VATTU(
    MAVT varchar(10) PRIMARY KEY, 
    TENVT nvarchar(50),
    DVTINH nvarchar(50),
    SLCON INT
);

CREATE TABLE HDBAN(
    MAHD varchar(10) PRIMARY KEY, 
    NGAYXUAT DATE,
    HOTENKHACH nvarchar(50)
);

CREATE TABLE HANGXUAT(
    MAHD varchar(10),
    MAVT varchar(10),
    DONGIA INT,
    SLBAN INT,
    CONSTRAINT HANGXUAT_PK PRIMARY KEY (MAHD, MAVT)
);

ALTER TABLE HANGXUAT ADD CONSTRAINT FK_HANGXUAT_HDBAN
FOREIGN KEY (MAHD) REFERENCES HDBAN (MAHD);
ALTER TABLE HANGXUAT ADD CONSTRAINT FK_HANGXUAT_VATTU
FOREIGN KEY (MAVT) REFERENCES VATTU (MAVT);

INSERT INTO VATTU VALUES
('VT01', 'GACH', 'VIEN', 100000),
('VT02', 'XI-MANG', 'BAO', 3000);

INSERT INTO HDBAN VALUES
('HD01', '2022-10-10', 'NGUYEN VAN TUAN'),
('HD02', '2022-10-15', 'TRAN VAN DAI');

INSERT INTO HANGXUAT VALUES
('HD01', 'VT01', 7000, 500),
('HD01', 'VT02', 35000, 30),
('HD02', 'VT01', 7200, 100),
('HD02', 'VT02', 38000, 40);


-- CAU 2
SELECT TOP 1
MAHD, SUM(SLBAN * DONGIA) AS N'Tổng Tiền'
FROM HANGXUAT
GROUP BY MAHD
ORDER BY SUM(SLBAN * DONGIA) Desc;

-- CAU 3
SELECT * FROM HDBan
IF OBJECT_ID('cauhoi3') IS NOT NULL
	DROP FUNCTION cauhoi3
GO
CREATE FUNCTION cauhoi3 (@MaHD VARCHAR(10))
RETURNS TABLE AS RETURN
    SELECT 
        HX.MaHD,
        HD.NgayXuat,
        HD.MaVT,
        HX.DonGia,
        HX.SLBan,  
        CASE
            WHEN WEEKDAY(HD.NGAYXUAT) = 0 THEN N'Thứ hai'            
            WHEN WEEKDAY(HD.NGAYXUAT) = 1 THEN N'Thứ ba'
            WHEN WEEKDAY(HD.NGAYXUAT) = 2 THEN N'Thứ tư'
            WHEN WEEKDAY(HD.NGAYXUAT) = 3 THEN N'Thứ năm'
            WHEN WEEKDAY(HD.NGAYXUAT) = 4 THEN N'Thứ sáu'
            WHEN WEEKDAY(HD.NGAYXUAT) = 5 THEN N'Thứ bảy'
            ELSE N'Chủ nhật'
        END AS NgayThu
    FROM HANGXUAT HX
    INNER JOIN HDBAN HD ON HX.MaHD = HD.MaHD
    WHERE HX.MaHD = @MaHD;

-- CAU 4
CREATE PROCEDURE cauhoi4
@MONTH INT, @YEAR INT
AS
SELECT
SUM(SLBan *DonGia)
FROM HANGXUAT HX
INNER JOIN HDBan HD ON HX.MaHD = HD.MaHD
WHERE MONTH(HD.NgayXuat) = @MONTH AND YEAR(HD.NgayXuat) = @YEAR;

